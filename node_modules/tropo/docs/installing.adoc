= Installing Tropo
:toc: left
:icons: font
:source-highlighter: highlightjs

The overall Tropo CLI installation consists of four major server (VM) installs, followed by setup procedures:

- Tropo AS (Application Server)
- Tropo Provisioning
- Little IMS
- Cloud Foundry (CF)

The following installation instructions were tested using Vagrant 1.2.2 and VirtualBox 4.2.8 on a Mac OS 10.8.4.

NOTE: A minimum of 8GB RAM is recommended

== Getting Started

. Create a working directory on your system (e.g. ~/Document/tropo-0.10).
. Deploy this Vagrantfile to your working directory: https://s3.amazonaws.com/chef-recipes-mcc20130423/Vagrantfile.
. Open a command prompt and cd to your working directory.
. Execute the following command to  start up the  four VMs:
. +vagrant up+
. Open three new command prompts and cd to your working directory.  (This means issuing one command prompt per VM.)   
. For each VM/command prompt, perform the following steps. To save time, we recommend that these steps be performed in parallel.

NOTE: This installation guide will refer to these command prompts as IMS, CF, Prov, and AS, respectively.

== IMS

=== Connect

----
vagrant ssh ims
sudo su -
----

=== Download

----
wget http://ci-voxeolabs-net.s3.amazonaws.com/tropo/tropo-all-0.8.0.tgz
tar xzvf tropo-all-0.8.0.tgz
cd tropo-all-0.8.0
----

=== Configure

Replace +install_lims.json+ with the following content:

[source,json]
----
{
    "ims" : {
        "ip" : "192.168.28.23",
        "as_address" : "sip:192.168.28.20:5060;lr",
        "domain" : "foo.bar",
        "domains" : "hss.foo.bar p-cscf.foo.bar s-cscf.foo.bar i-cscf.foo.bar foo.bar",
        "icscf" : {
            "host" : "i-cscf.foo.bar"
        },
        "scscf" : {
            "host" : "s-cscf.foo.bar"
        },
        "pcscf" : {
            "host" : "p-cscf.foo.bar"
        },
        "hss" : {
            "host" : "hss.foo.bar",
            "realm" : "foo.bar",
            "http_port" : 8080
        },
        "subscribers" : [
            { "address" : "alice@foo.bar", "tropo" : true },
            { "address" : "bob@foo.bar", "tropo" : false },
            { "address" : "carol@foo.bar", "tropo" : false }
        ]
    },
    "run_list" : [
      "recipe[base::default]",
      "recipe[little-ims::default]"
    ]
}
----

=== Install

----
./install_lims.sh
----

== Cloud Foundry

=== Connect

----
vagrant ssh cf
sudo su -
----

=== Download

----
wget http://ci-voxeolabs-net.s3.amazonaws.com/tropo/tropo-all-0.8.0.tgz
tar xzvf tropo-all-0.8.0.tgz
cd tropo-all-0.8.0
----

=== Configure

Replace +install_cf.json+ with the following content:

[source,json]
----
{
  "tropo" : {
    "nodejs" : {
      "version" : "0.10.17-1chl1~lucid1"
    }
  },
  "cf" : {
    "bind_address" : "192.168.28.21",
    "config_dir" : "~root/cloudfoundry/.deployments/devbox/config"
  },
  "run_list" : [
    "recipe[tropo::cf]"
  ]
}
----

=== Install

----
./install_cf.sh
----

=== SSH Configuration

----
ssh-keygen
----

Hit enter to create without a passphrase

----
cat /root/.ssh/id_rsa
----

IMPORTANT: Copy the output of this command to your local machine. You will need it when setting up Provisioning and AS components.

----
cp /root/.ssh/id_rsa.pub /root/.ssh/authorized_keys
chmod 400 /root/.ssh/authorized_keys
----

=== Restart & Verify

----
~root/cloudfoundry/vcap/dev_setup/bin/vcap_dev restart
----

Verify that all processes are “RUNNING”.

----
curl -v http://api.vcap.me/
----

Verify that response comes back 200 OK

=== Create Admin User

----
curl -v -X POST http://api.vcap.me/users -d '{ "email" : "tropo-provisioning@tropo.com", "password" : "ap"}'
----

Verify that the system responds with the following response: 204 No Content.

== Tropo Provisioning

=== Connect

----
vagrant ssh prov
sudo su -
----

=== Download

----
wget http://ci-voxeolabs-net.s3.amazonaws.com/tropo/tropo-all-0.8.0.tgz
tar xzvf tropo-all-0.8.0.tgz
cd tropo-all-0.8.0
----

=== Configure

Replace +install_provisioning.json+ with the following content: 

----
https://paste.voxeolabs.com/raw/kivonuluti
----

=== Install

----
./install_provisioning.sh
----

=== Create SSH Tunnel to CloudFoundry

----
mkdir /root/.ssh
chmod 600 /root/.ssh
----

Copy the +/root/.ssh/id_rsa+ from the Cloud Foumdry server to the same path on this server. If you followed the CF install steps, you should have the SSH key handy on your local machine.

----
chmod 400 /root/.ssh/id_rsa
/sbin/service monit restart
----

Wait 10 seconds

----
curl -v http://api.vcap.me
----

NOTE: Verify returns 200 OK

== Tropo AS

=== Connect

----
vagrant ssh runtime
sudo su -
----

=== Download

----
wget http://ci-voxeolabs-net.s3.amazonaws.com/tropo/tropo-all-0.8.0.tgz
tar xzvf tropo-all-0.8.0.tgz
cd tropo-all-0.8.0
----

=== Configure

Replace +install_runtime.json+ with the following content: 

----
https://paste.tropo.com/raw/tohavoxeme
----

=== Install

----
./install_as.sh
----

=== Host Entries

Add the following /etc/hosts entries:

----
https://paste.voxeolabs.com/raw/xubebutuna
----

=== Create SSH Tunnel to CloudFoundry

----
mkdir /root/.ssh
chmod 600 /root/.ssh
----

Copy the +/root/.ssh/id_rsa+ from the Cloud Foumdry server to the same path on this server. If you followed the CF install steps, you should have the SSH key handy on your local machine.

----
chmod 400 /root/.ssh/id_rsa
/sbin/service monit restart
----

Wait 10 seconds

----
curl -v http://api.vcap.me
----

NOTE: Verify returns 200 OK
