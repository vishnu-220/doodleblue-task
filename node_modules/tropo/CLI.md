# Command Line Interface (CLI)

The command line interface is available to Tropo application developers as well as Tropo operators
deploying applications into an Tropo private cloud as well as maintaining the deployment of Tropo
applications in the private cloud.

The CLI communicates over REST with the Tropo provisioning server. As needed, the issued command
is executed locally within the Tropo provisioning server and/or communicates with Cloud Foundry over
a separate REST API. For the end user this is not relevant as there is no difference between the
command communicating with Tropo provisioning alone or it in turn communicating with Cloud Foundry.

```
+-----+            +---------------------+            +---------------+
|     |            |                     |            |               |
| CLI +--- REST ---+ Tropo Provisioning  +--- REST ---+ Private Cloud |
|     |            |                     |            |               |
+-----+            +---------------------+            +---------------+
```

# Configuration File

In order to configure the Tropo provisioning connectivity and set up an initial user, add a configuration
file called '.tropoconf' into your home directory. The contents of it is as follows
(example connectivity specification):

```
{
  "provisioningServerUrl": "http://localhost:8080",
  "provisioningServerUsername": "admin",
  "provisioningServerPassword": "admin"
}
```

This specifies the URL of the Tropo provisioning server (e.g. Tropo running in PRISM), and the user name as
well as the password of the user accessing Tropo provisioning.

# Convenience Setup

Add '/../tropo/bin' to your environment path so that the command line interface is accessible easily from any
directory.

# Command Invocation

The command line interface is called 'tropo' and its general syntax is

```
tropo <command> [arg 1] [arg 2] [arg ...]
```

In many cases the command will prompt for input or indicates missing parameters. So if in doubt, just
call 'tropo &lt;command&gt;' and see the system either prompting for input or indicating missing arguments.

# Connectivity

The CLI requires connectivity with a Tropo provisioning server. In case this connectivity is not established,
an error message like the following will appear:

```
cbussler:revisions christoph$ tropo clouds list
error:   Tropo provisioning is not available
cbussler:revisions christoph$
```

# List of Commands

The following list contains all possible commands that can be issued from the command line interface.

## Help

This command lists all commands directly in the terminal:

```
tropo help
```

An example response is

```
cbussler:revisions christoph$ tropo help
Commands:
          addresses add <cloudId> <type> <value> | list | get <type> <value> | rm <type> <value>
          cloudfoundries info <url> (without http://)
          clouds add | list | update <id> | get <id> | rm <id>
          deploy
          help
          init
          login
          logs env <id> | staging <id> | stdout <id> | stderr <id>
          ping
          revisions list | deploy | get <id> | rm <id>
          subscriptions add | list | update <id> | get <id> | rm <id>
          tail env <id> | staging <id> | stdout <id> | stderr <id>
          tailf env <id> | staging <id> | stdout <id> | stderr <id>
          users add | list | get <username> | rm <username>
          whoami
cbussler:revisions christoph$
```

## Login

This command is used to login as a particular user.

Note: the login command is only setting the username and the user password (and as a side-effect updates '.tropoconf').
It does not (!) check if the user is actually known to Tropo provisioning. This becomes apparent when running a
different command as in case of a unknown user the error message 'invalid user/password' is displayed.

```
tropo login
```

An example login dialog is here:

```
cbussler:revisions christoph$ tropo login
prompt: username:  cb
prompt: password:
info:    Success.
cbussler:revisions christoph$
```

## Retrieving Identity

This command displays the current Tropo provisioning URL as well as the current username.

```
tropo whoami
```

A dialog could be:

```
cbussler:revisions christoph$ tropo whoami
provisioning server: http://localhost:8080/tropo-repo-cfintegration-SNAPSHOT
username: cb
info:    Success.
cbussler:revisions christoph$
```

## Checking Provisioning Server Connectivity

The following command checks if the Tropo provisioning server is accessible by the CLI:

```
tropo ping
```

If the result indicates that the server is inaccessible then the URL provided might be wrong
or the provisioning server is not up and running.

## Checking Cloud Foundry Connectivity

This will check if the Cloud Foundry PaaS located at '&lt;url$gt;' is accessible by Tropo provisioning.
Do not include the 'http://' into the '&lt;url&gt;'.

```
tropo cloudfoundries info <url>
```

An example check looks like this:

```
cbussler:revisions christoph$ tropo cloudfoundries info api.vcap.me
data:    { uri: 'http://localhost:8080/tropo-repo-cfintegration-SNAPSHOT/cloudfoundries/api.vcap.me',
  entity:
   { id: null,
     url: 'api.vcap.me',
     name: 'vcap',
     version: '0.999',
     errorMessage: null },
  links: [],
  getLink: [Function: getLink] }
info:    Success.
cbussler:revisions christoph$
```

## Managing Clouds

There is a set of commands around managing clouds. The following command is used to create a cloud:

```
tropo clouds add
```

Note that currently only one cloud can exist at any point in time.

A dialog for adding a cloud look like:

```
cbussler:revisions christoph$ tropo clouds add
prompt: name:  mycloud
prompt: platformUrl:  api.vcap.me
prompt: platformUseremail:  tropo-provisioning@voxeolabs.com
prompt: platformPassword:  ap
prompt: cfOrganization:  tropo
prompt: cfSpace:  amecheApps
prompt: cfAppDomain:  (null) 
prompt: cfAppUrlScheme:  (http) 
prompt: defaultMaxSubscribersPerInstance:  (1) 
prompt: defaultMinSubscriptionCapacity:  (1) 
prompt: maxApplicationInstances:  (null) 
prompt: defaultMinimumInstanceAge:  (600) 
prompt: defaultMemorySizePerInstance:  (64) 
prompt: httpProxy:  (null) 
prompt: httpsProxy:  (null) 
info:    Success.
cbussler:revisions christoph$
```

This command is used to list all specified clouds:

```
tropo clouds list
```

The output of this command can be:

```
cbussler:revisions christoph$ tropo clouds list
Cloud Id	Cloud Name	Platform Url
--------	----------	-----------
3       	mycloud	    api.vcap.me
info:    Success.
cbussler:revisions christoph$
```

The following command is used to retrieve details about the cloud whereby the '&lt;id&gt;' is the identifier
of the cloud as listed through 'tropo clouds list':

```
tropo clouds get <id>
```

The information of a cloud looks like:

```
cbussler:revisions christoph$ tropo clouds get 3
data:    { uri: 'http://localhost:8080/tropo-repo-cfintegration-SNAPSHOT/clouds/3',
  entity:
   { id: 3,
     name: 'mycloud',
     platformUrl: 'api.vcap.me',
     platformUseremail: 'tropo-provisioning@voxeolabs.com',
     platformPassword: 'ap',
     cfOrganization: 'tropo',
     cfSpace: 'amecheApps',
     cfAppDomain: null, 
     cfAppUrlScheme: 'http', 
     defaultMaxSubscribersPerInstance: 1,
     defaultMinSubscriptionCapacity: 1,
     maxApplicationInstances: null,
     defaultMinimumInstanceAge: 600,
     defaultMemorySizePerInstance: 64,
     httpProxy: null,
     httpsProxy: null},
  links: [],
  getLink: [Function: getLink] }
info:    Success.
cbussler:revisions christoph$
```

This command is used to remove a cloud whereby '&lt;id&gt;' is the identifier of the cloud as listed through
'tropo clouds list':

```
tropo clouds rm <id>
```

## Managing Users

In order to manage users there is a set of commands available. This is used to add a user:

```
tropo users add
```

This is used to list all users:

```
tropo users list
```

This command is available to retrieve the details of a user whereby '&lt;username&gt;' is a name from the
list obtained through 'tropo users list':

```
tropo users get <username>
```

Deleting a user is done through:

```
tropo users rm <username>
```

## Managing Revisions

Terminology-wise, on the UI surface a 'revision' corresponds to an application revision. Often 'application' is
confused with 'revision'. For example, people ask 'have you downloaded this app?' and the answer might be 'yes!'.
In this case a version of the application was downloaded, i.e., a specific revision or version of the application, 
not 'the' application. Sometimes the meaning is clear from the context, sometimes not, and then proper naming 
might be important to avoid misunderstandings.

A revision is a revision of an application. The first revision will implicitly create an application, however,
the concept of application is not visible at the user interface. The only location where the application is
visible is the UUID of the application in package.json. 

In order to get started, the following command creates a very simple, but complete revision:

```
tropo init
```

An alternative is

```
tropo revisions init
```

This can be used by a developer as a starting point to get going on Tropo application development.

A revision is deployed with the command

```
tropo deploy
```
An alternative command with the same semantics is:

```
tropo revisions deploy
```

An actual dialog looks like:

```
cbussler:helloWorld christoph$ tropo deploy
npm WARN package.json helloWorld@0.0.0 No repository field.
npm WARN package.json helloWorld@0.0.0 No readme data.
wrote npm-shrinkwrap.json
ls -al
helloWorld-0.0.0.tgz
info:    Success.
--- start staging_task.log content ----
[2013-07-02 13:53:53] Setting up temporary directories
[2013-07-02 13:53:53] Downloading application
[2013-07-02 13:53:53] Unpacking application
[2013-07-02 13:53:53] Staging application
[2013-07-02 13:53:54] Creating droplet
[2013-07-02 13:53:54] Uploading droplet
[2013-07-02 13:53:55] Done!

--- end staging_task.log content ----
--- start stdout.log content ----
Server running at http://127.0.0.1:8000/

--- end stdout.log content ----
--- start stderr.log content ----

--- end stderr.log content ----
cbussler:helloWorld christoph$ ls -al
```

There is no argument necessary. 'tropo deploy' inspects the directory, adds a npm-shrinkwrap.json file,
creates a .tgz file and sends it to the provisioning server.

```
cbussler:helloWorld christoph$ ls -al
total 32
drwxr-xr-x   6 christoph  staff   204 Jul  2 13:52 .
drwxr-xr-x  17 christoph  staff   578 Jul  2 13:49 ..
-rw-r--r--   1 christoph  staff  1477 Jul  2 13:53 helloWorld-0.0.0.tgz
-rw-r--r--   1 christoph  staff   460 Jul  2 13:51 index.js
-rw-r--r--   1 christoph  staff    49 Jul  2 13:52 npm-shrinkwrap.json
-rw-r--r--   1 christoph  staff   295 Jul  2 13:52 package.json
cbussler:helloWorld christoph$
```

The 'package.json' file must contain an Tropo provisioning specific structure.
If 'package.json' misses the application UUID, one will be created by 'tropo deploy'. Here is an
example of a 'package.json'. A rudimentary one is created by 'tropo init'.

```
cbussler:foo christoph$ more package.json
{
        "name" : "foo",
        "version" : "1.2.3",
        "description" : "an app revision",
        "tropo" : {
                "uuid" : "foo3",
                "displayName" : "An App Revision",
                "configUrl": "config.com/url",
                "iconUrl" : "icon.com/url",
                "permissions" : [
                    "CALL_OFFER",
                        "CALL_WHISPER"
                ]
        },
        "dependencies": {
            "express": "*"
        },
        "engines": {
            "node": "0.8.x"
        }
}
cbussler:foo christoph$
```

Revisions can be listed through:

```
tropo revisions list
```

The following command supports retrieving information about an existing revision whereby '&lt;id&gt;'
is the identifier of a revision:

```
tropo revisions get <id>
```

A revision is removed through

```
tropo revisions rm <id>
```

## Managing Addresses

A set of commands is available for managing addresses. Adding an address is done this way:

```
tropo addresses add
```

Listing existing addresses is done with this command:

```
tropo addresses list
```

Getting details about an address is accomplished this way (with '&lt;id&gt;' being an identifier of an
existing address):

```
tropo addresses get <type> <value>
```

Removing an address is accomplished this way:

```
tropo addresses rm <type> <value>
```

## Managing Revision Instances

Revision instances are created as a side effect of deploying revisions. They are also removed
as a side effect of removing a revision. So there are no commands for creating or deleting
revision instances. However, they can be listed:

## Retrieving Logs

Revision instances have four types of logs: env, staging, stdout and stderr. 'env' contains
the environment variables of the revision instance. 'staging', 'stdout' and 'stderr' contain
log statements related to staging or running the revision instance.

To retrieve the staging log, use:

```
tropo logs staging <id>
```

An example for staging is:

```
cbussler:revisions christoph$ tropo logs staging 8
--- start staging_task.log content ----
[2013-06-19 16:31:27] Setting up temporary directories
[2013-06-19 16:31:27] Downloading application
[2013-06-19 16:31:27] Unpacking application
[2013-06-19 16:31:27] Staging application
[2013-06-19 16:31:28] Creating droplet
[2013-06-19 16:31:28] Uploading droplet
[2013-06-19 16:31:29] Done!

--- end staging_task.log content ----
```

```
tropo logs stdout <id>
```

```
tropo logs stderr <id>
```

```
tropo logs env <id>
```

whereby '&lt;id&gt;' is the identifier of the revision instance.

This particular design was chosen so that logs can be easily processed in the usual Unix piped way,
e.g.:

```
cbussler:revisions christoph$ tropo logs staging 8 | grep droplet
[2013-06-19 16:31:28] Creating droplet
[2013-06-19 16:31:28] Uploading droplet
cbussler:revisions christoph$
```

## Retrieving tails of logs

The commands for tailing logs is analogous to fetching logs:

```
tropo tail staging <id>
```

This will fetch 2500 characters from the end of the staging log. In order to define a custom tail
length, use

```
tropo tail staging
```

and the CLI will prompt for the '&lt;id&gt;' and the '&lt;tailLength&gt;' (in bytes).

The commands for continuously tailing logs is analogous to fetching logs also:

```
tropo tailf stderr <id>
```

will continuously tail stderr of the specified revision instance. stdout, env and staging are supported
also.

## Managing Subscriptions

There are several commands for managing subscriptions. Adding a subscription is done this way:

```
tropo subscriptions add
```

Listing existing subscriptions is done with this command:

```
tropo subscriptions list
```

Getting details about a subscription is accomplished this way (with '&lt;id&gt;' being an identifier of an
existing subscription):

```
tropo subscriptions get <id>
```

Removing a subscription is accomplished this way:

```
tropo subscriptions rm <id>
```

Subscriptions can be updated and the command is

```
tropo subscriptions update <id>
```
