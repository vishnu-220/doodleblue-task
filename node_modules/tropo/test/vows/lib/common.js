var assert = require('assert'),
    cli = require('../../../lib/cli'),
    util = require('util');


module.exports.cli = cli;

var makeTopic = module.exports.makeTopic = function(opts) {
    var result = function() {
        if (opts.setup) {
            opts.setup();
        }
        cli.argv._ = opts.argv;
        var callback = this.callback; 
        cli.go(function () {
            try {
                callback.apply(this,arguments);
            } finally {
                if (opts.cleanup) {
                    opts.cleanup();
                }
            }
        });
    };
    return result;
}

var makeTest = module.exports.makeTest = function(opts) {
    var result = {
            topic : makeTopic(opts)
    };
    
    var assertions = opts.assertions;
    if (assertions) {
        for (var assertion in assertions) {
            result[assertion] = assertions[assertion];
        }
    } else {
        result['no errors'] = function(err) {
            if (err) {
                console.log('errr', util.inspect(err));
                console.log(err.stack);
            }
            assert.ok(!err);
        };
    }
    
    return result;
}